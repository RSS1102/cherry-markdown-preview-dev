name: Cross-Platform File Processor

on:
  push:
    branches: [ main ]

jobs:
  file-processing:
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-latest
            shell: bash
            search_path: "packages/client/**/*.json"
          - platform: windows-latest
            shell: pwsh
            search_path: "packages/client/**/*.json"
          - platform: macos-latest
            shell: bash
            search_path: "packages/client/**/*.json"

    steps:
      - uses: actions/checkout@v4

      - name: Locate Files
        id: find_files
        shell: ${{ matrix.shell }}
        run: |
          echo "扫描路径: ${{ matrix.search_path }}"
          
          # Linux/macOS 使用find命令
          if [[ "${{ runner.os }}" == "Linux" || "${{ runner.os }}" == "macOS" ]]; then
            files=$(find packages/client -type f -name "*.json" | tr '\n' ' ')
          
          # Windows 使用PowerShell命令
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            files=$(Get-ChildItem -Path ${{ matrix.search_path }} -Recurse | % { $_.FullName }) | Out-String
          fi

          # 标准化输出路径
          normalized_files=$(echo "$files" | sed 's/\/\//\//g')
          echo "files=${normalized_files}" >> $GITHUB_OUTPUT
          echo "发现文件数量: $(echo "$normalized_files" | wc -w)"

      - name: Upload Artifacts
        if: ${{ steps.find_files.outputs.files != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: json-files-${{ matrix.platform }}-${{ github.run_number }}
          path: ${{ steps.find_files.outputs.files }}
          retention-days: 3
