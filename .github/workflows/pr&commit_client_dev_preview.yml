name: Cross-Platform JSON Processor

on:
  push:
    branches: [ main ]

jobs:
  file-processing:
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-latest
            shell: bash
            search_path: "packages/client"
          - platform: windows-latest
            shell: pwsh
            search_path: "packages/client"
          - platform: macos-latest
            shell: bash
            search_path: "packages/client"

    steps:
      - uses: actions/checkout@v4

      # æ–‡ä»¶æŸ¥æ‰¾æ­¥éª¤ï¼ˆä¿®å¤çŸ©é˜µå˜é‡å¼•ç”¨ï¼‰
      - name: Locate JSON Files
        id: find_files
        shell: ${{ matrix.shell }}
        run: |
          echo "ğŸ•µï¸ æ­£åœ¨æ‰«æè·¯å¾„: ${{ matrix.search_path }}"
          
          # è·¨å¹³å°å…¼å®¹å‘½ä»¤ï¼ˆæ ¹æ®ç½‘é¡µ3å’Œç½‘é¡µ5æœ€ä½³å®è·µï¼‰
          if [[ "${{ runner.os }}" == "Linux" || "${{ runner.os }}" == "macOS" ]]; then
            files=$(find ${{ matrix.search_path }} -type f -name "*.json" | tr '\n' ' ')
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            files=$(Get-ChildItem -Path "${{ matrix.search_path }}" -Filter *.json -Recurse | % { $_.FullName })
            files=$($files -join " ")
          fi

          # æ ‡å‡†åŒ–è·¯å¾„è¾“å‡ºï¼ˆç½‘é¡µ8å»ºè®®ï¼‰
          normalized_files=$(echo "$files" | sed 's/\\/\//g' | sed 's/\/\//\//g')
          echo "files=${normalized_files}" >> $GITHUB_OUTPUT
          echo "âœ… å‘ç° ${#files[@]} ä¸ªJSONæ–‡ä»¶"

      # æ„ä»¶ä¸Šä¼ æ­¥éª¤ï¼ˆä¿®å¤æ¡ä»¶åˆ¤æ–­ï¼‰
      - name: Upload JSON Files
        if: ${{ !contains(matrix.platform, 'windows') || steps.find_files.outputs.files != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: json-${{ matrix.platform }}-${{ github.run_number }}
          path: ${{ fromJSON(format('["{0}"]', steps.find_files.outputs.files)) }}
          retention-days: 3
          if-no-files-found: warn
